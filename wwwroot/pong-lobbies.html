<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pong Lobbies</title>
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      padding: 10px;
      margin: 0;
      background: #071021;
      color: #eaffff;
    }

    h1 {
      font-size: 1.5em;
      margin-bottom: 12px;
      text-align: center;
    }

    #list {
      margin-top: 12px;
    }

    .lobby {
      padding: 12px;
      border: 1px solid #555;
      margin-bottom: 8px;
      cursor: pointer;
      word-break: break-word;
      border-radius: 6px;
    }

    .controls {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
    }

    button {
      padding: 10px 14px;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.12);
      background: transparent;
      color: #b6f0ff;
      cursor: pointer;
      font-size: 1em;
      flex: 1 1 auto;
      min-width: 90px;
    }

    #status {
      margin-top: 12px;
      color: #9fb6c2;
      text-align: center;
      font-size: 1em;
    }

    /* Overlay Box */
    .overlay-box {
      background: #0d1b2a;
      padding: 20px 24px;
      border-radius: 8px;
      color: #eaffff;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      text-align: center;
      min-width: 280px;
      max-width: 90vw;
    }

    .overlay-box input {
      width: 100%;
      padding: 10px;
      border: 1px solid #555;
      border-radius: 4px;
      background: #132238;
      color: #b6f0ff;
      font-size: 16px;
      margin-bottom: 12px;
      box-sizing: border-box;
    }

    .overlay-box button {
      font-size: 1em;
      padding: 8px 12px;
    }

    /* Small screen scaled-down */
    @media (max-width: 400px) {
      h1 { font-size: 1.5em; } 
      .lobby { font-size: 0.9em; padding: 8px; } 
      button { font-size: 1em; padding: 6px 8px; min-width: 40px; }
      #status { font-size: 1em; }
      .overlay-box { padding: 10px; min-width: 85vw; }
      .overlay-box input { font-size: 12px; padding: 5px; }
      .overlay-box button { font-size: 1em; padding: 6px 8px; }
    }

    /* Optional landscape tweak */
    @media (orientation: landscape) and (max-height: 400px) {
      body { padding: 5px; }
      h1 { font-size: 1.3em; }
      button { font-size: 0.9em; padding: 5px 6px; }
      .lobby { font-size: 0.9em; padding: 6px; }
      #status { font-size: 0.9em; }
    }
  </style>
</head>
<body>
  <h1>Pong Lobbies</h1>
  <div class="controls">
    <button id="createBtn">Create Lobby</button>
    <button id="refreshBtn">Refresh</button>
  </div>
  <div id="status">Connecting...</div>
  <div id="list"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/9.0.6/signalr.min.js"></script>
  <script>
    const conn = new signalR.HubConnectionBuilder()
      .withUrl("/ponggamehub?context=lobby")
      .withAutomaticReconnect()
      .build();
    const statusElem = document.getElementById('status');
    const listElem = document.getElementById('list');

    conn.onclose(() => statusElem.textContent = 'Disconnected');
    conn.onreconnecting(() => statusElem.textContent = 'Reconnecting...');
    conn.onreconnected(() => { statusElem.textContent = 'Connected'; loadLobbies(); });

    conn.on("Matched", (lobbyId, side) => {
      setTimeout(() => {
        window.location.href = `pong-duel.html?lobbyId=${encodeURIComponent(lobbyId)}&side=${encodeURIComponent(side)}`;
      }, 150);
    });

    conn.on("LobbiesUpdated", loadLobbies);

    async function start() {
      await conn.start();
      statusElem.textContent = 'Connected';
      loadLobbies();
    }

    async function loadLobbies() {
      const arr = await conn.invoke("ListLobbies");
      listElem.innerHTML = "";
      if (!arr || arr.length === 0) {
        listElem.textContent = "No open lobbies";
      } else {
        arr.forEach(l => {
          const d = document.createElement('div');
          d.className = 'lobby';
          d.textContent = `${l.lobbyName} — Players: ${l.players}/2`;
          d.onclick = async () => {
            const ok = await conn.invoke('JoinLobby', l.lobbyId);
            if (!ok) alert('Could not join — maybe full.');
          };
          listElem.appendChild(d);
        });
      }
    }

    function showLobbyNamePrompt(defaultName = "Pong Duel") {
      return new Promise((resolve, reject) => {
        const overlay = document.createElement('div');
        overlay.style.position = 'fixed';
        overlay.style.top = 0;
        overlay.style.left = 0;
        overlay.style.width = '100vw';
        overlay.style.height = '100vh';
        overlay.style.background = 'rgba(0,0,0,0.6)';
        overlay.style.display = 'flex';
        overlay.style.alignItems = 'center';
        overlay.style.justifyContent = 'center';
        overlay.style.zIndex = 9999;

        const box = document.createElement('div');
        box.className = 'overlay-box';

        const label = document.createElement('div');
        label.textContent = 'Enter lobby name:';
        label.style.marginBottom = '10px';

        const input = document.createElement('input');
        input.type = 'text';
        input.value = defaultName;
        input.maxLength = 60;
        input.select();

        const btnOk = document.createElement('button');
        btnOk.textContent = 'OK';
        btnOk.style.marginRight = '8px';

        const btnCancel = document.createElement('button');
        btnCancel.textContent = 'Cancel';

        const btnRow = document.createElement('div');
        btnRow.append(btnOk, btnCancel);

        box.append(label, input, btnRow);
        overlay.appendChild(box);
        document.body.appendChild(overlay);

        function cleanup() { overlay.remove(); }

        btnCancel.addEventListener('click', () => { cleanup(); reject('cancelled'); });
        btnOk.addEventListener('click', () => {
          let lobbyName = input.value.trim().replace(/[^a-zA-Z0-9 _()\-]/g, '');
          if (!lobbyName) { alert('Please enter a valid lobby name.'); return; }
          cleanup();
          resolve(lobbyName);
        });

        input.addEventListener('keydown', e => {
          if (e.key === 'Enter') btnOk.click();
          if (e.key === 'Escape') btnCancel.click();
        });
      });
    }

    document.getElementById('createBtn').addEventListener('click', async () => {
      try {
        const lobbyName = await showLobbyNamePrompt("Pong Duel");
        await conn.invoke('CreateLobby', lobbyName);
      } catch (e) {
        if (e !== 'cancelled') console.error(e);
      }
    });

    document.getElementById('refreshBtn').addEventListener('click', loadLobbies);

    start().catch(err => {
      console.error(err);
      statusElem.textContent = 'Connection failed';
    });
  </script>
</body>
</html>
