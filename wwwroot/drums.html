<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Generative Drum Machine ‚Äî Single File</title>
<style>
  :root{
    --bg:#0b0f17;--bg2:#0f1522;--card:#111826;--edge:#1f2a3c;--fg:#e7ecef;--muted:#9aa6b2;
    --brand:#57e6c1;--brand2:#76ffd9;--accent:#ffd166;--danger:#ff6b6b;--ok:#68e0a4;
  }
  html,body{height:100%}
  body{margin:0;background:radial-gradient(1200px 800px at 12% -10%, #10202b 0, transparent 60%),
                  radial-gradient(1000px 700px at 110% 10%, #0e1a13 0, transparent 55%), var(--bg);
       color:var(--fg);font:15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif}
  .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
  h1{font-size:28px;margin:0 0 12px;color:var(--brand2)}
  .sub{color:var(--muted);margin-bottom:18px}

  .panel{display:grid;grid-template-columns: 1.2fr 2fr;gap:14px;align-items:start}
  .card{background:linear-gradient(180deg, #0f1624aa, #0b1220c5);border:1px solid var(--edge);
        border-radius:14px;padding:12px}

  .controls{display:grid;grid-template-columns: repeat(2, minmax(0,1fr));gap:10px}
  .controls label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
  .row{display:flex;gap:8px;align-items:center}
  input[type="range"]{width:100%}
  select, button, input[type="number"], input[type="text"]{
    background:#0d1422;border:1px solid var(--edge);color:var(--fg);border-radius:10px;
    padding:8px 10px;font:inherit
  }
  button{cursor:pointer}
  button.primary{background:linear-gradient(180deg, #1a2a3f, #152233);border-color:#203048}
  button.good{background:linear-gradient(180deg, #173125, #13271f);border-color:#1a3f2d}
  button.bad{background:linear-gradient(180deg, #3a1616, #2a1010);border-color:#4a2020}
  .pads{display:grid;gap:8px}
  .track{display:grid;grid-template-columns: 120px repeat(var(--cols), 1fr);gap:6px;align-items:center}
  .track .name{color:#b8c3cf}
  .step{height:28px;border-radius:8px;border:1px solid var(--edge);background:#0f1726;position:relative}
  .step.on{background:linear-gradient(180deg,#22344f,#18253a)}
  .step.play::after{content:"";position:absolute;inset:0;border:2px solid var(--brand);border-radius:8px}
  .meter{height:8px;background:#0d1422;border:1px solid var(--edge);border-radius:999px;overflow:hidden}
  .meter > i{display:block;height:100%;background:linear-gradient(90deg,var(--brand),var(--brand2))}
  .muted{opacity:.65}
  .small{font-size:12px;color:var(--muted)}
  .footer{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:10px}
  .badgelite{background:#0d1422;border:1px solid var(--edge);padding:6px 8px;border-radius:8px;color:var(--muted)}

  .gridwrap{overflow:auto;padding-bottom:6px}
  .legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .legend span{font-size:12px;color:var(--muted)}

  @media (max-width: 900px){
    .panel{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>Generative Drum Machine</h1>
  <div class="sub">Plays drum grooves at any tempo. Pick a style, tweak swing/complexity, and regenerate variations ‚Äî or click the grid to edit.</div>

  <div class="panel">
    <div class="card">
      <div class="controls">
        <div>
          <label>Tempo (BPM)</label>
          <div class="row"><input id="bpm" type="range" min="50" max="200" value="110"><input id="bpmNum" type="number" min="50" max="200" value="110" style="width:80px"></div>
        </div>
        <div>
          <label>Style</label>
          <select id="style">
            <option value="rock">Rock (straight 8ths)</option>
            <option value="hiphop">Hip‚Äëhop (boom‚Äëbap)</option>
            <option value="house">House (four‚Äëon‚Äëthe‚Äëfloor)</option>
            <option value="dnb">Drum & Bass (2‚Äëstep)</option>
            <option value="jazz">Jazz swing (ride)</option>
            <option value="latin">Latin (clave‚Äëish)</option>
          </select>
        </div>
        <div>
          <label>Complexity</label>
          <div class="row"><input id="complex" type="range" min="0" max="100" value="45"><span id="complexLbl" class="badgelite">45%</span></div>
        </div>
        <div>
          <label>Swing</label>
          <div class="row"><input id="swing" type="range" min="0" max="65" value="0"><span id="swingLbl" class="badgelite">0%</span></div>
        </div>
        <div>
          <label>Bars</label>
          <select id="bars">
            <option value="1">1 bar (16 steps)</option>
            <option value="2" selected>2 bars (32 steps)</option>
          </select>
        </div>
        <div>
          <label>Humanize</label>
          <select id="humanize">
            <option value="light" selected>Light</option>
            <option value="med">Medium</option>
            <option value="off">Off</option>
          </select>
        </div>
        <div class="row" style="grid-column:1 / -1; gap:10px; margin-top:4px">
          <button id="start" class="primary">‚ñ∂Ô∏é Start</button>
          <button id="regen" class="good">üîÅ Regenerate</button>
          <button id="clear" class="bad">‚úñÔ∏é Clear</button>
          <button id="tap" title="Tap Tempo">üëÜ Tap</button>
        </div>
        <div style="grid-column:1 / -1">
          <label>Master Volume</label>
          <div class="row" style="gap:12px"><input id="master" type="range" min="0" max="1" step="0.01" value="0.9"><span class="small">Kick</span><input id="vkick" type="range" min="0" max="1" step="0.01" value="1"><span class="small">Bass</span><input id="vbd" type="range" min="0" max="1" step="0.01" value="0.9"><span class="small">Snare</span><input id="vsnare" type="range" min="0" max="1" step="0.01" value="0.9"><span class="small">Hat</span><input id="vhat" type="range" min="0" max="1" step="0.01" value="0.7"><span class="small">Clap</span><input id="vclap" type="range" min="0" max="1" step="0.01" value="0.6"></div>
        </div>
      </div>
      <div class="legend">
        <span>‚Ä¢ Click steps to toggle</span>
        <span>‚Ä¢ Regenerate for new variation</span>
        <span>‚Ä¢ Swing/jazz: try 55‚Äì60%</span>
      </div>
    </div>

    <div class="card gridwrap">
      <div id="pads" class="pads"></div>
      <div class="footer">
        <div class="badgelite">Now Playing: <b id="now">‚Äî</b></div>
        <div class="badgelite">Resolution: 1/16 notes</div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const bpm = $('#bpm'), bpmNum = $('#bpmNum');
  const styleSel = $('#style');
  const complex = $('#complex'), complexLbl = $('#complexLbl');
  const swing = $('#swing'), swingLbl = $('#swingLbl');
  const barsSel = $('#bars');
  const humanizeSel = $('#humanize');
  const startBtn = $('#start');
  const regenBtn = $('#regen');
  const clearBtn = $('#clear');
  const tapBtn = $('#tap');
  const pads = $('#pads');
  const nowLbl = $('#now');
  const vMaster = $('#master');
  const vKick = $('#vkick'), vBD = $('#vbd'), vSnare = $('#vsnare'), vHat = $('#vhat'), vClap = $('#vclap');

  let audioCtx, master, running=false;
  let lookahead = 25; // ms
  let scheduleAheadTime = 0.12; // seconds to schedule ahead
  let current16th = 0; // which 16th note is next
  let nextNoteTime = 0.0; // when the next note is due
  let timerID;

  const tracks = [
    { id:'kick',  name:'Kick',  color:'#a4ffd6' },
    { id:'bd',    name:'Bass Drum',  color:'#aeb6ff' },
    { id:'snare', name:'Snare', color:'#ffd4a4' },
    { id:'hat',   name:'Hat',   color:'#d6e6ff' },
    { id:'clap',  name:'Clap',  color:'#f4b7ff' },
  ];

  let cols = 32; // default 2 bars
  let grid = {}; // id -> [bool]

  function setCols(n){
    cols = n; document.documentElement.style.setProperty('--cols', String(cols));
  }

  function createGrid(){
    pads.innerHTML = '';
    tracks.forEach(t => {
      const row = document.createElement('div');
      row.className = 'track';
      row.style.setProperty('--cols', cols);
      const label = document.createElement('div');
      label.className = 'name';
      label.textContent = t.name;
      row.appendChild(label);
      grid[t.id] = Array(cols).fill(false);
      for(let i=0;i<cols;i++){
        const step = document.createElement('div');
        step.className = 'step';
        step.dataset.id = t.id;
        step.dataset.col = String(i);
        // subtle separators every 4
        if(i%4===0) step.style.boxShadow = 'inset 2px 0 0 #1a2940';
        step.addEventListener('click', () => {
          const on = (grid[t.id][i] = !grid[t.id][i]);
          step.classList.toggle('on', on);
        });
        row.appendChild(step);
      }
      pads.appendChild(row);
    });
  }

  function highlight(col){
    $$('.step.play').forEach(s => s.classList.remove('play'));
    $$('.track').forEach(tr => {
      const steps = tr.querySelectorAll('.step');
      if(steps[col]) steps[col].classList.add('play');
    });
  }

  // ---------- Sound Engines (no external samples) ----------
  function makeMaster(){
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    master = audioCtx.createGain();
    master.gain.value = parseFloat(vMaster.value);
    master.connect(audioCtx.destination);
  }
  function setGains(){ master.gain.value = parseFloat(vMaster.value); }

  function hitKick(time, vel=1){
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = 'sine';
    o.frequency.setValueAtTime(150, time);
    o.frequency.exponentialRampToValueAtTime(50, time+0.1);
    g.gain.setValueAtTime(0.0001, time);
    g.gain.exponentialRampToValueAtTime(1.0*vel*parseFloat(vKick.value), time+0.001);
    g.gain.exponentialRampToValueAtTime(0.0001, time+0.35);
    o.connect(g).connect(master);
    o.start(time); o.stop(time+0.4);
    // click
    const click = audioCtx.createBufferSource();
    click.buffer = noiseBuffer(0.003);
    const cg = audioCtx.createGain();
    cg.gain.value = 0.25*vel*parseFloat(vKick.value);
    click.connect(cg).connect(master);
    click.start(time);
  }
  function hitBD(time, vel=1){
    // 808-style bass drum: long sine drop + tiny click
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type='sine';
    o.frequency.setValueAtTime(90, time);
    o.frequency.exponentialRampToValueAtTime(40, time+0.35);
    g.gain.setValueAtTime(0.0001, time);
    g.gain.exponentialRampToValueAtTime(1.2*vel*parseFloat(vBD.value), time+0.005);
    g.gain.exponentialRampToValueAtTime(0.0001, time+0.8);
    o.connect(g).connect(master);
    o.start(time); o.stop(time+0.85);
    const click = audioCtx.createBufferSource();
    click.buffer = noiseBuffer(0.004);
    const cg = audioCtx.createGain(); cg.gain.value = 0.15*vel*parseFloat(vBD.value);
    click.connect(cg).connect(master);
    click.start(time);
  }
  function hitSnare(time, vel=1){
    const n = audioCtx.createBufferSource();
    n.buffer = noiseBuffer(0.18);
    const bp = audioCtx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=1800; bp.Q.value=0.7;
    const hp = audioCtx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=500;
    const g = audioCtx.createGain(); g.gain.value = 0.9*vel*parseFloat(vSnare.value);
    n.connect(bp).connect(hp).connect(g).connect(master);
    n.start(time);
    // tonal body
    const o = audioCtx.createOscillator(); o.type='triangle'; o.frequency.setValueAtTime(190, time);
    const og = audioCtx.createGain(); og.gain.setValueAtTime(0.15*vel*parseFloat(vSnare.value), time);
    og.gain.exponentialRampToValueAtTime(0.0001, time+0.15);
    o.connect(og).connect(master);
    o.start(time); o.stop(time+0.2);
  }
  function hitHat(time, vel=1){
    const n = audioCtx.createBufferSource();
    n.buffer = noiseBuffer(0.05);
    const hp = audioCtx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=6000;
    const g = audioCtx.createGain(); g.gain.value = 0.6*vel*parseFloat(vHat.value);
    n.connect(hp).connect(g).connect(master);
    n.start(time);
  }
  function hitClap(time, vel=1){
    // three short noise taps
    const taps = [0, 0.012, 0.024];
    taps.forEach(off => {
      const n = audioCtx.createBufferSource(); n.buffer = noiseBuffer(0.08);
      const bp = audioCtx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=2000; bp.Q.value=0.7;
      const g = audioCtx.createGain(); g.gain.value = 0.5*vel*parseFloat(vClap.value);
      n.connect(bp).connect(g).connect(master);
      n.start(time+off);
    });
  }
  function noiseBuffer(dur){
    const len = Math.max(1, Math.floor((audioCtx.sampleRate||44100)*dur));
    const buf = (audioCtx||{createBuffer:()=>null}).createBuffer(1, len, audioCtx.sampleRate||44100);
    const data = buf.getChannelData(0);
    for(let i=0;i<len;i++) data[i] = (Math.random()*2-1) * Math.pow(1-i/len, 2);
    return buf;
  }

  // ---------- Generator ----------
  function prob(base, c){ // complexity in [0..1]
    return Math.min(1, base + c*0.8);
  }
  function coin(p){ return Math.random() < p; }

  function regenerate(){
    const style = styleSel.value;
    const comp = parseInt(complex.value)/100;
    for(const t of tracks) grid[t.id].fill(false);

    const isTwo = (cols===32);
    const steps = cols;

    const put = (id, i, dens=1) => { if(i>=0 && i<steps && coin(dens)) grid[id][i]=true; };

    if(style==='rock'){
      for(let i=0;i<steps;i+=4){ grid.kick[i]=true; } // 4 on downbeats
      for(let i=2;i<steps;i+=8){ grid.snare[i]=true; } // backbeats 2 & 4
      for(let i=0;i<steps;i++){ if(i%2===0) grid.hat[i]=true; }
      for(let i=0;i<steps;i++) if(coin(prob(0.08,comp))) grid.kick[i]=grid.kick[i]||coin(0.6);
      for(let i=1;i<steps;i+=2) if(coin(prob(0.05,comp))) grid.hat[i]=true;
      if(coin(0.5)) for(let i=6;i<steps;i+=8) grid.clap[i]=true;
    }
    else if(style==='hiphop'){
      for(let b=0;b<steps;b+=8){ grid.kick[b]=true; grid.snare[b+4]=true; }
      for(let i=0;i<steps;i++) if(coin(prob(0.7,comp))) grid.hat[i]= (i%2===0);
      for(let i=1;i<steps;i+=2) if(coin(prob(0.15,comp))) grid.hat[i]=true; // off hats
      for(let i=0;i<steps;i++) if(coin(prob(0.08,comp))) grid.kick[i]=true;
      if(coin(0.6)) for(let i=4;i<steps;i+=8) grid.clap[i]=true;
    }
    else if(style==='house'){
      for(let i=0;i<steps;i+=4) grid.kick[i]=true; // 4-on-floor
      for(let i=2;i<steps;i+=4) grid.hat[i]=true; // open hat on off-beats
      for(let i=0;i<steps;i++) if(coin(prob(0.1,comp))) grid.snare[i]= (i%8===2||i%8===6);
      for(let i=0;i<steps;i++) if(coin(prob(0.06,comp))) grid.clap[i]= (i%8===6);
    }
    else if(style==='dnb'){
      for(let b=0;b<steps;b+=16){ grid.snare[b+8]=true; grid.snare[b+12]=coin(0.6); }
      for(let i=0;i<steps;i++) if(i%4===0) grid.kick[i]=coin(0.9);
      for(let i=0;i<steps;i++) if(coin(prob(0.85,comp))) grid.hat[i]= (i%2===0);
      for(let i=0;i<steps;i++) if(coin(prob(0.15,comp))) grid.kick[i]=true;
      for(let i=0;i<steps;i++) if(coin(prob(0.08,comp))) grid.clap[i]= (i%8===0);
    }
    else if(style==='jazz'){
      // ride pattern: swing 8th feel approximated in 16ths
      for(let b=0;b<steps;b+=8){ grid.hat[b]=true; grid.hat[b+3]=true; grid.hat[b+6]=true; }
      for(let b=0;b<steps;b+=16){ grid.snare[b+10]=coin(0.7); grid.snare[b+14]=coin(0.5); }
      for(let i=0;i<steps;i+=16){ grid.kick[i]=true; }
      for(let i=0;i<steps;i++) if(coin(prob(0.10,comp))) grid.kick[i]=true;
      for(let i=0;i<steps;i++) if(coin(prob(0.06,comp))) grid.clap[i]= (i%8===6);
    }
    else if(style==='latin'){
      // simple clave-ish feel
      const clave = [0, 4, 8, 10, 14];
      clave.forEach(i=>{ put('clap', i, 1); if(isTwo) put('clap', i+16, 1); });
      for(let i=0;i<steps;i+=4) grid.kick[i]=coin(0.8);
      for(let i=0;i<steps;i++) if(i%2===0) grid.hat[i]=true;
      for(let i=0;i<steps;i++) if(coin(prob(0.12,comp))) grid.kick[i]=true;
      for(let i=0;i<steps;i++) if(coin(prob(0.08,comp))) grid.snare[i]= (i%8===6);
    }
    // Bass drum (808-ish) base: downbeat booms, more in hip-hop/house
    for(let b=0;b<steps;b+=16) if(coin(prob(0.6, comp))) grid.bd[b]=true;
    if(style==='hiphop' || style==='house') for(let b=8;b<steps;b+=16) if(coin(prob(0.4, comp))) grid.bd[b]=true;

    // reflect in UI
    $$('.track').forEach((tr, r)=>{
      const id = tracks[r].id;
      const stepsEls = tr.querySelectorAll('.step');
      for(let c=0;c<cols;c++) stepsEls[c].classList.toggle('on', !!grid[id][c]);
    });
  }

  // ---------- Transport ----------
  function nextNote(){
    const spb = 60 / parseInt(bpm.value); // seconds per beat (quarter)
    let inc = spb / 4; // 16th
    // swing: delay even 16ths (1-based offbeats) by swing% of the 8th-note portion
    const sw = parseInt(swing.value)/100; // 0..0.65
    const posIn8th = current16th % 2; // 0,1 within 8th
    if(sw>0 && posIn8th===1){ inc += (spb/2 - spb/4) * sw; }
    nextNoteTime += inc;
    current16th = (current16th + 1) % cols;
  }

  function schedule(){
    while(audioCtx && nextNoteTime < audioCtx.currentTime + scheduleAheadTime){
      scheduleStep(current16th, nextNoteTime);
      nextNote();
    }
    timerID = setTimeout(schedule, lookahead);
  }

  function humanize(){
    const h = humanizeSel.value;
    if(h==='off') return 0;
    if(h==='light') return (Math.random()-0.5)*0.006; // +-6ms
    return (Math.random()-0.5)*0.012; // +-12ms
  }

  function scheduleStep(col, time){
    highlight(col);
    nowLbl.textContent = `Step ${col+1}/${cols}`;
    const jitter = humanize();
    const t = time + jitter;
    const hit = (id, vel=1) => {
      if(id==='kick') hitKick(t, vel);
      else if(id==='bd') hitBD(t, vel);
      else if(id==='snare') hitSnare(t, vel);
      else if(id==='hat') hitHat(t, vel);
      else if(id==='clap') hitClap(t, vel);
    };
    // play active cells
    for(const tr of tracks){ if(grid[tr.id][col]) hit(tr.id, 1); }
    // accents every 4 steps lightly (only hats) to give feel
    if(col%4===0 && grid.hat[col]) hit('hat', 1.1);
  }

  function play(){
    if(running) { stop(); return; }
    if(!audioCtx) makeMaster();
    setGains();
    running = true; startBtn.textContent = '‚ñ† Stop';
    current16th = 0; nextNoteTime = audioCtx.currentTime + 0.06;
    schedule();
  }
  function stop(){
    running=false; startBtn.textContent = '‚ñ∂Ô∏é Start';
    try{ clearTimeout(timerID); }catch{}
    $$('.step.play').forEach(s=>s.classList.remove('play'));
    nowLbl.textContent = '‚Äî';
  }

  // ---------- Tap Tempo ----------
  const taps = [];
  function tap(){
    const t = performance.now();
    taps.push(t); if(taps.length>6) taps.shift();
    if(taps.length>=2){
      const intervals = [];
      for(let i=1;i<taps.length;i++) intervals.push(taps[i]-taps[i-1]);
      const avg = intervals.reduce((a,b)=>a+b,0)/intervals.length;
      const bpmVal = Math.max(50, Math.min(200, Math.round(60000/avg)));
      bpm.value = bpmNum.value = bpmVal;
    }
  }

  // ---------- Wiring ----------
  bpm.addEventListener('input', ()=> bpmNum.value=bpm.value);
  bpmNum.addEventListener('input', ()=> bpm.value=bpmNum.value);
  complex.addEventListener('input', ()=> complexLbl.textContent = complex.value+"%");
  swing.addEventListener('input', ()=> swingLbl.textContent = swing.value+"%");

  vMaster.addEventListener('input', setGains);
  [vKick,vBD,vSnare,vHat,vClap].forEach(e=> e.addEventListener('input', setGains));

  startBtn.addEventListener('click', play);
  regenBtn.addEventListener('click', regenerate);
  clearBtn.addEventListener('click', ()=>{ for(const t of tracks) grid[t.id].fill(false); $$('.step').forEach(s=>s.classList.remove('on')); });
  tapBtn.addEventListener('click', tap);

  barsSel.addEventListener('change', ()=>{ setCols(parseInt(barsSel.value)*16); createGrid(); regenerate(); });

  styleSel.addEventListener('change', regenerate);

  // init
  setCols(parseInt(barsSel.value)*16);
  createGrid();
  regenerate();
})();
</script>
</body>
</html>
